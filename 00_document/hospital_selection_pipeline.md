# 119 구급대원 이송대상기관 선정 파이프라인 설계안

##  개요
119 구급대원 현장응급처치 표준지침(2023년 개정본)의 "이송대상기관 선정 및 결정" 지침을 반영한 병원 선정 파이프라인입니다.

---

## 🔄 전체 파이프라인 흐름

### **Phase 1: 환자 정보 수집 및 중증도 평가**

#### 1.1 현장 정보 수집
```
[구급대원 입력]
├─ 현위치 (GPS 좌표 또는 주소)
├─ 환자 증상 (음성/텍스트 입력)
└─ STT 텍스트 (의학용어 번역 포함)
```

#### 1.2 중증도 분류 (Pre-KTAS)
```
[증상 기반 자동 분류]
├─ Level 1 (소생): 심정지, 무호흡, 중증외상(쇼크), 의식장애(GCS 3-8)
├─ Level 2 (긴급): 심인성 흉통, 뇌졸중 의심(발병<6시간), 대량 출혈
├─ Level 3 (응급): 발작 후 의식회복, 지속적 구토, 명백한 변형 손상
├─ Level 4 (준응급): 지혈된 출혈, 봉합 필요 열상
└─ Level 5 (비응급): 만성 질환, 사소한 증상
```

#### 1.3 환자 유형 분류
```
[증상 매핑]
├─ 외상 환자
│   ├─ 중증외상: "다발성 외상/중증 외상", "신경외과 응급"
│   └─ 경증외상: 기타 외상 관련 증상
├─ 비외상 환자
│   ├─ 중증비외상: "심근경색 의심", "뇌졸중 의심"
│   └─ 경증비외상: 기타 비외상 증상
├─ 심폐정지: Level 1 + 심정지 증상
└─ 뇌졸중의증: "뇌졸중 의심(FAST+)" + Pre-KTAS Level 2
```

---

### **Phase 2: 의료기관 등급 및 치료 능력 평가**

#### 2.1 의료기관 등급 분류
```
[API 데이터 기반]
├─ 권역외상센터 (dutyEmclsName에 "권역외상센터" 포함)
├─ 외상전문의 수련센터
├─ 지역응급의료센터 (dutyDivNam: "2", "3" 또는 "권역")
└─ 지역응급의료기관 (dutyDivNam: "1" 또는 일반)
```

#### 2.2 치료 능력 평가
```
[증상별 필수 요구사항]
├─ 장비 조건 (bool_any): CT, MRI, 조영촬영기, 인공호흡기 등
├─ 병상 조건 (min_ge1): 수술실, 중환자실, 신경외과중환자실 등
└─ 우선 조건 (nice_to_have): 추가 병상/장비
```

---

### **Phase 3: 병원 선정 로직 (지침 기반)**

#### 3.1 중증외상환자 (Level 1-2 + 외상)
```
[우선순위]
1순위: 권역외상센터 또는 외상전문의 수련센터
  └─ 조건: 중증외상 진료 가능 + 거리 최소화
  └─ 행정구역 무관, 물리적 거리 우선

2순위: 지역응급의료센터 이상
  └─ 조건: 중증외상 진료 가능 + 거리 최소화
  └─ 권역외상센터가 없는 지역의 경우

3순위: 헬기 이송 고려
  └─ 조건: 구급차 이송 시간 > 헬기 이륙 시간(15분) + 비행 시간
  └─ 의료지도 요청

4순위: 의료지도 연계
  └─ 조건: 위 기준으로도 선정 어려운 경우
```

#### 3.2 경증외상환자
```
[우선순위]
1순위: 가장 가까운 지역응급의료기관
  └─ 조건: 거리 최소화
  └─ 지도의사 지도 시 우회 가능
```

#### 3.3 중증비외상환자 (Level 1-2 + 비외상)
```
[우선순위]
1순위: 지역응급의료센터 이상
  └─ 조건: 치료 가능 + 거리 최소화
  └─ 의료지도 고려

2순위: 지역응급의료기관
  └─ 조건: 치료 가능 + 거리 최소화
  └─ 응급의료 취약지역의 경우

3순위: 의료지도 연계
```

#### 3.4 경증비외상환자
```
[우선순위]
1순위: 가장 가까운 지역응급의료기관
  └─ 조건: 거리 최소화
  └─ 지도의사 지도 시 우회 가능
```

#### 3.5 심폐정지환자
```
[우선순위]
1순위: 가장 가까운 지역응급의료기관 이상
  └─ 조건: 거리 최소화 (시간이 생명)
```

#### 3.6 뇌졸중의증환자
```
[우선순위]
1순위: 지역응급의료센터 이상 + 혈전용해술 가능
  └─ 조건: hvctayn="Y" (CT 보유) + 거리 최소화
  └─ 발병 6시간 이내 우선

2순위: 지역응급의료센터 이상
  └─ 조건: 치료 가능 + 거리 최소화

3순위: 지역응급의료기관
  └─ 조건: 응급의료 취약지역의 경우

4순위: 의료지도 연계
```

---

### **Phase 4: 병원 검색 및 필터링**

#### 4.1 검색 범위 확장 전략
```
[1차: 현위치 행정구역]
├─ 현재 sigungu 내 병원 검색
└─ 조건: 증상별 필수 요구사항 충족

[2차: 인접 행정구역 (같은 sido)]
├─ 현재 sido 내 다른 sigungu 검색
├─ 거리순 정렬 (물리적 거리 기준)
└─ 최대 3개 행정구역까지 확장

[3차: 인접 광역시/도 (필요시)]
├─ 조건: 광역시에서 병원을 못 찾은 경우
├─ 인접 도로 확장 (예: 광주 → 전라남도)
└─ 최대 3개 행정구역까지 확장
```

#### 4.2 병원 필터링 및 정렬
```
[1단계: 필수 조건 필터링]
├─ 증상별 필수 장비/병상 조건 충족 (OR 조건)
└─ 의료기관 등급 조건 충족

[2단계: 우선순위 정렬]
├─ 1순위: 의료기관 등급 (권역외상센터 > 지역응급의료센터 > 지역응급의료기관)
├─ 2순위: 치료 능력 점수 (_requirement_score)
└─ 3순위: 물리적 거리 (distance_km)

[3단계: Top3 선정]
└─ 상위 3개 병원 선정
```

---

### **Phase 5: 병원 연락 및 수용 확인**

#### 5.1 병원 연락 파이프라인
```
[Top3 병원 순차 연락]
├─ 1순위 병원
│   ├─ Twilio 자동 전화
│   ├─ ARS: "1번 입실 승인, 2번 입실 거절"
│   └─ 응답 대기 (최대 30초)
│
├─ 1순위 거절 시 → 2순위 병원
│   └─ 동일 프로세스
│
└─ 2순위 거절 시 → 3순위 병원
    └─ 동일 프로세스
```

#### 5.2 하이브리드 백업 전략
```
[모든 Top3 거절 시]
├─ 백업 병원 리스트 (4-13순위)에서 추가 검색
│   └─ 동일 조건으로 연락
│
├─ 백업 병원도 모두 거절 시
│   └─ 인접 행정구역 병원 리스트 (neighbor_hospitals)에서 추가 검색
│
└─ 모든 병원 거절 시
    ├─ 의료지도 요청 (수동)
    └─ 사용자에게 "새로고침" 안내
```

---

### **Phase 6: 최종 이송 결정 및 경로 안내**

#### 6.1 승인된 병원 확인
```
[승인 병원이 있는 경우]
├─ 최종 이송 병원 결정
├─ 지도에 경로 표시 (구급대원 위치 → 승인 병원)
└─ 거리 및 예상 소요 시간 표시
```

#### 6.2 모든 병원 거절 시
```
[모든 병원 거절]
├─ 지도에 모든 거절된 병원 위치 표시
├─ 각 병원별 색상 구분 마커
└─ 의료지도 요청 안내
```

---

##  구현 개선 사항

### **현재 시스템 vs 지침 기반 시스템**

| 항목 | 현재 시스템 | 지침 기반 시스템 |
|------|------------|----------------|
| **중증도 분류** | 증상만 입력 | Pre-KTAS Level 1-5 자동 분류 |
| **의료기관 등급** | 표시만 함 | 선정 기준에 반영 (우선순위) |
| **거리 기준** | 행정구역 우선 → 거리 | 물리적 거리 우선 |
| **환자 유형별 로직** | 증상별 장비/병상 조건만 | 환자 유형별 차별화된 선정 기준 |
| **헬기 이송 고려** | 없음 | 구급차 vs 헬기 시간 비교 |
| **의료지도 연계** | 없음 | 선정 어려운 경우 의료지도 요청 |

### **필요한 데이터 추가**

1. **의료기관 등급 정보**
   - `dutyEmclsName`: "권역외상센터", "외상전문의 수련센터" 등
   - `dutyDivNam`: "1", "2", "3", "권역" 등

2. **Pre-KTAS Level 매핑**
   - 증상 → Pre-KTAS Level 자동 매핑 테이블

3. **헬기 이송 시간 계산**
   - 헬기 이륙 시간: 15분 (고정)
   - 현장까지 비행 시간: 거리 기반 추정

---

##  우선순위 점수 계산식 (제안)

```python
def calculate_priority_score(hospital, patient_type, severity_level, user_location):
    """
    병원 우선순위 점수 계산
    
    Args:
        hospital: 병원 정보 딕셔너리
        patient_type: 환자 유형 ("중증외상", "경증외상", "중증비외상", "경증비외상", "심폐정지", "뇌졸중")
        severity_level: Pre-KTAS Level (1-5)
        user_location: 사용자 위치 (lat, lon)
    
    Returns:
        priority_score: 우선순위 점수 (높을수록 우선)
    """
    
    # 1. 의료기관 등급 점수 (0-100)
    grade_score = 0
    if "권역외상센터" in hospital.get("dutyEmclsName", ""):
        grade_score = 100
    elif "외상전문의 수련센터" in hospital.get("dutyEmclsName", ""):
        grade_score = 90
    elif hospital.get("dutyDivNam") in ["2", "3", "권역"]:
        grade_score = 70
    elif hospital.get("dutyDivNam") == "1":
        grade_score = 50
    else:
        grade_score = 30
    
    # 2. 치료 능력 점수 (0-100)
    treatment_score = hospital.get("_requirement_score", 0.0) * 100
    
    # 3. 거리 점수 (0-100, 가까울수록 높음)
    distance_km = hospital.get("distance_km", float('inf'))
    if distance_km == float('inf'):
        distance_score = 0
    else:
        # 50km 이내: 100점, 100km 이내: 50점, 그 이상: 0점 (선형 보간)
        distance_score = max(0, 100 - (distance_km / 50) * 50)
    
    # 4. 환자 유형별 가중치
    weights = {
        "중증외상": {"grade": 0.5, "treatment": 0.3, "distance": 0.2},
        "경증외상": {"grade": 0.2, "treatment": 0.2, "distance": 0.6},
        "중증비외상": {"grade": 0.4, "treatment": 0.3, "distance": 0.3},
        "경증비외상": {"grade": 0.1, "treatment": 0.2, "distance": 0.7},
        "심폐정지": {"grade": 0.2, "treatment": 0.2, "distance": 0.6},
        "뇌졸중": {"grade": 0.3, "treatment": 0.4, "distance": 0.3},
    }
    
    w = weights.get(patient_type, {"grade": 0.3, "treatment": 0.3, "distance": 0.4})
    
    # 최종 점수 계산
    priority_score = (
        grade_score * w["grade"] +
        treatment_score * w["treatment"] +
        distance_score * w["distance"]
    )
    
    return priority_score
```

---

##  구현 우선순위

### **Phase 1 (즉시 구현 가능)**
1.  환자 유형별 선정 로직 분기
2.  의료기관 등급을 우선순위에 반영
3.  물리적 거리 우선 정렬

### **Phase 2 (데이터 보강 필요)**
1. Pre-KTAS Level 자동 분류
2. 헬기 이송 시간 계산 및 비교
3. 의료지도 연계 UI/로직

### **Phase 3 (장기 개선)**
1. 지역 이송지침 연동
2. 실시간 병상 가용성 확인
3. 의료지도 연계 API 연동

---

##  참고사항

- **지역 이송지침**: 일부 지역은 별도의 이송지침이 있을 수 있으므로, 해당 지역에서는 지침보다 지역 이송지침을 우선 적용
- **의료지도**: 모든 자동 선정이 실패하거나 특수한 경우 의료지도의사에게 직접 연락하여 결정
- **응급의료 취약지역**: 헬기 이송을 고려하거나 가장 가까운 응급의료기관으로 이송

